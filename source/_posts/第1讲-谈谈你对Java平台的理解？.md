---
title: 第1讲 | 谈谈你对Java平台的理解？
date: 2019-04-24 14:15:45
tags: 
     - JAVA 
     - Java核心技术36讲
toc: true
---

# 第1讲 | 谈谈你对Java平台的理解？

杨晓峰 2018-05-05

极客时间版权所有: https://time.geekbang.org/column/article/6845



**谈谈你对java平台的理解？ “java是解释执行”，这句话正确吗？**

**典型回答**

java本身是一种面向对象的语言，最显著的特性有两个方面，一是所谓的“**书写一次，到处运行**”（write once， run anywhere），能够非常容易地获得跨平台能力；另外就是**垃圾收集**（GC， Garbage Collection），java通过垃圾收集器回收分配内存，大部分情况下，程序员不需要自己操心内存的分配和回收。

我们日常会接触到JRE（Java Runtime Environment）或者JDK（Java Development Kit）。JRE也就是java运行环境，包含了JVM和Java类库，以及一些模块等。而JDK可以看作是JRE的一个超集，提供了更多工具，比如编译器、各种诊断工具等。

对于“Java是解释执行”这句话，这个说法不太准确。我们开发的java的源代码，首先通过javac编译成为字节码（bytecode），然后，在运行时，通过Java虚拟机（JVM）内嵌的解释器将字节码转换成为最终的机器码。但是常见的JVM，比如我们大多数情况使用的Oracle JDK提供的Hotspot JVM，都提供了JIT（Just In Time）编译器，也就是通常所说的动态编译器，JIT能够在运行时将热点代码编译成机器码，这种情况下部分热点代码也就属于**编译执行**,而不是解释执行了。

<!--more-->

**考点分析**

对于这类笼统的问题，你需要尽量**表现出自己的思维深入并系统化，Java知识理解得也比较全面**，一定要避免让面试官觉得你是个“知其然而不知其所以然”的人。毕竟明白基本组成和机制，是日常工作中进行问题诊断或者性能调优等很多事情的基础，相信没有招聘方会不喜欢“热爱学习和思考”的面试者。

**知识扩展**

回归正题，对于Java平台的理解，可以从很多方面简明扼要的谈一下，例如：Java语言特性，包括泛型、Lambda等语言特性；基础类库，包括集合、IO/NIO、网络、并发、安全等基础类库。对于我们日常工作应用较多的类库，面试前可以系统化总结一下，有助于临场发挥。

或者谈谈JVM的一些基础概念和机制，比如Java的类加载机制，常见版本JDK（如JDK8）内嵌的Class-Loader，例如Bootstap、Application和Extension Class-loader；类加载大致过程：加载、验证、链接、初始化（这里参考了周志明的《深入理解java虚拟机》）；自定义Class-loader等。还有垃圾收集的基本原理，最常见的垃圾收集器，如SerialGc、Parallel GC、CMS、G1等，对于适用于什么样的工作负载最好也心里有数。这些都是可以扩展开的领域。

当然还有JDK包含哪些工具或者Java领域内其它工具等，如编译器、运行时环境、安全工具、诊断和监控工具等。这些基本工具是日常工作效率的保证，对于我们工作在其它语言平台上，同样有所帮助，很多都是触类旁通的。

下图是一个相对宽泛的蓝图

![img](https://static001.geekbang.org/resource/image/20/32/20bc6a900fc0b829c2f0e723df050732.png)



众所周知，我们通常把java分为编译期和运行时。这里说的java的编译和C/C++是有着不同的意义的，javac的编译，编译java源码生成“.class”文件里面实际是字节码，而不是可以直接执行的机器码。java通过字节码和java虚拟机（JVM）这种跨平台的抽象，屏蔽了操作系统和硬件的细节，这也是实现“一次编译，到处执行”的基础。



在运行时，JVM会通过类加载器（Class-Loader）加载字节码，解释或者编译执行。主流java版本中，如JDK8实际是解释和编译混合的一种模式，即所谓的混合模式（-Xmixed）。通常运行在server模式的JVM，会进行上万次调用以收集足够的信息进行高效的编译，client模式这个门限是1500次。Oracle Hospot JVM内置了两个不同的JIT compiler， C1对应前面说的client模式，适用于对于启动速度敏感的应用，比如普通java桌面应用；C2对应server模式，它的优化是为长时间运行的服务器端应用设计的。默认是采用所谓的分层编译（TieredCompilation）。

java虚拟机启动时，可以指定不同的参数对运行模式进行选择。比如，指定“-Xint”，就是告诉JVM只进行解释执行，不对代码进行编译，这种模式抛弃了JIT可能带来的性能优势。毕竟解释器（interpreter）是逐条读入，逐条解释运行的。与其相对应的，还有一个“-Xcomp” 参数，这是告诉JVM关闭解释器，不要进行解释执行，或者叫做最大优化级别。“-Xcomep”会导致JVM启动变慢非常多，同时有些JIT编译器优化方式，比如分支预测，如果不进行profiling，往往并不能进行有效优化。

除了我们日常最常见的java使用模式，其实还有一种新的编译方式，即所谓的AOT（Ahead-of-Time Compilation），直接将字节码编译成机器代码，这样就避免了JIT预热等各方面的开销，比如Oracle JDK9 就引入了实验性的AOT特性，并且增加了新的jaotc工具。利用下面的命令把某个类或者某个模块编译成功AOT库。



```
jaotc --output libHelloWorld.so HelloWorld.class
jaotc --output libjava.base.so --module java.base

```

然后，在启动时直接指定就可以了。

```
java -XX:AOTLibrary=./libHelloWorld.so,./libjava.base.so HelloWorld

```

而且，Oracle JDK支持分层编译和AOT协作使用，这两者并不是二选一的关系。如果你有兴趣，可以参考相关文档：http://openjdk.java.net/jeps/295。AOT也不仅仅只有这一种方式，业界早就有第三方工具（如GCJ、Excelsior JET）提供相关功能。

另外，JVM作为一个强大的平台，不仅仅只有java语言可以运行在JVM上，本质上合规的字节码都可以运行，java语言自身也为此提供了便利，我们可以看到类似Clojure、Scala、Groovy、JRuby、Jython等大量JVM语言，活跃在不同的场景。

**学习心得**

“一次编译、到处运行”说的是Java语言跨平台的特性，Java的跨平台特性与Java虚拟机的存在密不可分，可在不同的环境中运行。比如说Windows平台和Linux平台都有相应的JDK，安装好JDK后也就有了java语言的运行环境。其实Java语言本身与其他的编程语言没有特别大的差异，并不是说Java语言可以跨平台，而是在不同的平台都有可以让Java语言运行的环境而已，所以才有了java一次编译，到处运行这样的效果。

​     严格的讲，跨平台的语言不止Java一种，但Java是较为成熟的一种。“一次编译，到处运行”这种效果跟编译器有关。编程语言的处理需要编译器和解释器。java虚拟机和DOS类似，相当于一个供程序运行的平台。

​     程序从源代码到运行的三个阶段：编码——编译——运行——调试。java在编译阶段则体现了跨平台的特点。编译过程大概是这样的：首先是将java源代码转化成.CLASS文件字节码，这是第一次编译。.CLASS文件就是可以到处运行的文件。然后java字节码会被转化为目标机器代码，这是由JVM来执行的，即java的第二次编译。

​    “到处运行”的关键和前提就是JVM。因为在第二次编译中JVM起着关键作用。在可以运行java虚拟机的地方都内含着一个JVM操作系统。从而使JAVA提供了各种不同平台上的虚拟机制，因此实现了“到处运行”的效果。需要强调的一点是，java并不是编译机制，而是解释机制。java字节码的设计充分考虑了JIT这一即时编译方式，可以将字节码之间转化成高性能的本地机器码，这同样是虚拟机的一个构成部分。